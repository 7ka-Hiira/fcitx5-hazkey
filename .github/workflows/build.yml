name: Build Workflow

on:
  push:
    tags:
      - '*'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v2

    - name: Install Swift Environment
      run: |
        wget https://download.swift.org/swift-5.10.1-release/ubuntu2204/swift-5.10.1-RELEASE/swift-5.10.1-RELEASE-ubuntu22.04.tar.gz
        tar xf swift-5.10.1-RELEASE-ubuntu22.04.tar.gz
        sudo mv swift-5.10.1-RELEASE-ubuntu22.04 /usr/share/swift
        echo "PATH=/usr/share/swift/usr/bin:$PATH" >> $GITHUB_ENV

    - name: Install C++/CMake Build Environment
      run: |
        sudo apt-get update -y
        sudo apt-get install -y build-essential cmake gettext

    - name: Install Fcitx5 libs
      run: |
        sudo apt-get install -y libfcitx5core-dev libfcitx5config-dev libfcitx5utils-dev

    - name: Set INSTALL_PREFIX
      run: |
        mkdir -p $GITHUB_WORKSPACE/workdir/usr/lib/
        mkdir -p $GITHUB_WORKSPACE/workdir/usr/include/
        echo "INSTALL_PREFIX=$GITHUB_WORKSPACE/workdir/usr" >> $GITHUB_ENV
      shell: /usr/bin/bash -e {0}

    - name: Run build scripts
      run: |
        ./build_install.sh

    - name: Pack Build Artifacts
      run: |
        cd $GITHUB_WORKSPACE/workdir
        tar -czvf fcitx5-hazkey-x86_64.tar.gz ./usr

    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v2
      with:
        name: fcitx5-hazkey-x86_64
        path: ${{ github.workspace }}/workdir/fcitx5-hazkey-x86_64.tar.gz